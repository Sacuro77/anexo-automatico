<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {% if importacion.status == "PENDING" or importacion.status == "RUNNING" %}
      <meta http-equiv="refresh" content="2" />
    {% endif %}
    <title>Detalle importación</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f7f7fb;
        color: #111;
        margin: 0;
        padding: 0;
      }
      main {
        max-width: 960px;
        margin: 40px auto;
        padding: 0 20px 60px;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 12px 36px rgba(0, 0, 0, 0.08);
        padding: 24px;
      }
      dl {
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 8px 12px;
      }
      dt {
        font-weight: 600;
        color: #374151;
      }
      dd {
        margin: 0;
      }
      pre {
        background: #111827;
        color: #f9fafb;
        padding: 16px;
        border-radius: 10px;
        overflow-x: auto;
      }
      a {
        color: #2563eb;
        text-decoration: none;
      }
      button {
        background: #2563eb;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
      }
      .notice {
        margin: 8px 0 16px;
        color: #6b7280;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }
      .table-compact {
        margin-bottom: 16px;
      }
      .table-compact tbody tr:nth-child(even) {
        background: #f9fafb;
      }
      th,
      td {
        text-align: left;
        padding: 10px 8px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 14px;
      }
      th {
        color: #374151;
        font-weight: 600;
      }
      .num {
        text-align: right;
        width: 120px;
      }
      .badge-low {
        color: #b91c1c;
        font-weight: 600;
      }
      .badge-medium {
        color: #b45309;
        font-weight: 600;
      }
      .badge-high {
        color: #15803d;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <main>
      <div class="card">
        <h1>Importación #{{ importacion.id }}</h1>
        {% if importacion.status == "PENDING" or importacion.status == "RUNNING" %}
          <p class="notice">Procesando: esta página se actualizará automáticamente.</p>
        {% endif %}
        <p>
          <a href="{% url 'ingesta-index' %}">Volver</a>
          · <a href="{% url 'ingesta-revisar' %}">Revisar sugerencias</a>
          · <a href="{% url 'ingesta-export-csv' importacion.id %}">Descargar CSV</a>
          · <a href="{% url 'ingesta-export-plan-json' importacion.id %}">Descargar plan (JSON)</a>
          ·
          <form method="post" action="{% url 'agente-generate-token' importacion.id %}" style="display: inline">
            {% csrf_token %}
            <button type="submit">Generar token para agente</button>
          </form>
        </p>
        <dl>
          <dt>Estado</dt>
          <dd>{{ importacion.status }}</dd>
          <dt>Creada</dt>
          <dd>{{ importacion.created_at }}</dd>
          <dt>Inició</dt>
          <dd>{{ importacion.started_at|default:"-" }}</dd>
          <dt>Finalizó</dt>
          <dd>{{ importacion.finished_at|default:"-" }}</dd>
          <dt>Archivos</dt>
          <dd>{{ importacion.total_archivos }}</dd>
          <dt>Facturas</dt>
          <dd>{{ importacion.total_facturas }}</dd>
          <dt>Proveedores</dt>
          <dd>{{ importacion.total_proveedores }}</dd>
          <dt>Errores</dt>
          <dd>{{ importacion.error_count }}</dd>
          <dt>Resumen</dt>
          <dd>{{ importacion.error_summary|default:"-" }}</dd>
          <dt>ZIP S3</dt>
          <dd>{{ importacion.s3_key_zip|default:"-" }}</dd>
        </dl>
        <h2>Resumen por categoría</h2>
        {% if resumen_por_categoria %}
          <table class="table-compact">
            <thead>
              <tr>
                <th>Categoría</th>
                <th class="num"># Facturas</th>
              </tr>
            </thead>
            <tbody>
              {% for item in resumen_por_categoria %}
                <tr>
                  <td>{{ item.nombre_categoria }}</td>
                  <td class="num">{{ item.count }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="notice">Sin datos.</p>
        {% endif %}
        <h2>Sugerencias de clasificación</h2>
        <p class="notice">
          {% if fallback_message %}
            {{ fallback_message }}
          {% else %}
            Mostrando {{ factura_sugerencias|length }} de {{ factura_total }} (límite {{ factura_limit }}).
          {% endif %}
        </p>
        {% if factura_sugerencias %}
          <table>
            <thead>
              <tr>
                <th>Clave acceso</th>
                <th>RUC</th>
                <th>Razón social</th>
                <th>Categoría sugerida</th>
                <th>Confianza</th>
              </tr>
            </thead>
            <tbody>
              {% for item in factura_sugerencias %}
                <tr>
                  <td>{{ item.factura.clave_acceso }}</td>
                  <td>{{ item.factura.proveedor.ruc }}</td>
                  <td>{{ item.factura.proveedor.razon_social|default:"-" }}</td>
                  <td>
                    {% if item.asignacion and item.asignacion.categoria_sugerida %}
                      {{ item.asignacion.categoria_sugerida.nombre }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if item.asignacion %}
                      <span class="badge-{{ item.asignacion.confianza|lower }}">
                        {{ item.asignacion.confianza }}
                      </span>
                    {% else %}
                      -
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% elif not fallback_message %}
          <p class="notice">Sin sugerencias aún.</p>
        {% endif %}
        <h2>Log</h2>
        <pre>{{ importacion.log_json|default:""|pprint }}</pre>
      </div>
    </main>
  </body>
</html>
