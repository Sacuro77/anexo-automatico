{
  "_comment": "Reemplace los selectores y pasos con los reales del SRI.",
  "target_url_login": "https://srienlinea.sri.gob.ec",
  "debug_table_steps_sample": {
    "steps": [
      {
        "type": "assertOnPage",
        "urlPattern": "anexo-gastos-personales|anexos\\.jsf",
        "anyText": ["Anexos"]
      }
    ]
  },
  "provider_open": {
  "steps": [
    {
      "type": "ensureSidebarOpen",
      "hamburger": "button#sri-menu",
      "sidebar1": "#mySidebar",
      "sidebar2": "#mySidebar2"
    },
    {
      "type": "trySteps",
      "log": "provider_open: si ya estamos en facturas, no navegar; caso contrario ir a anexos",
      "steps": [
        {
          "type": "assertOnPage",
          "urlPattern": "anexo-gastos-personales/facturas-electronicas-agrupadas\\.jsf|facturas-electronicas-agrupadas\\.jsf|facturas-electronicas\\.jsf\\?emisor=",
          "anyText": ["Facturas electrónicas por proveedor","Facturas electrónicas"]
        },
        { "type": "sleep", "ms": 1 }
      ],
      "fallbackSteps": [
        { "type": "clickAny", "selectors": ["css=#mySidebar a.ui-panelmenu-header-link:has-text('ANEXOS')","css=#mySidebar span.ui-menuitem-text:has-text('ANEXOS')"] },
        { "type": "clickAny", "selectors": ["css=#mySidebar a.ui-menuitem-link:has-text('Anexo de gastos personales en línea')","css=#mySidebar span.ui-menuitem-text:has-text('Anexo de gastos personales en línea')"] },
        { "type": "clickAny", "selectors": ["css=#mySidebar a.ui-menuitem-link:has-text('Generación anexo')","css=#mySidebar a.ui-menuitem-link[href*='tportal-internet/accederAplicacion.jspa?redireccion=101&idGrupo=98']","css=#mySidebar a.ui-menuitem-link[href*='tportal-internet/accederAplicacion.jspa?redireccion=101']"] },
        { "type": "waitForURL", "timeout": 60000, "pattern": "accederAplicacion\\.jspa|/anexo-gastos-personales/anexos\\.jsf" },
        { "type": "assertOnPage", "urlPattern": "anexos\\.jsf", "anyText": ["Anexos de Gastos Personales", "Anexos"] },
        { "type": "waitForSelector", "timeout": 60000, "selector": "css=table#anexos\\:lista-anexos" },
        { "type": "clickAny", "logUrl": true, "selectors": [
          "css=table#anexos\\:lista-anexos tr:has(td:nth-child(1):has-text('{{periodoTarget}}')) a.titulado[href*='editar-anexo.jsf'][href*='anexo=']",
          "css=table#anexos\\:lista-anexos tr:has(td:has-text('{{periodoTarget}}')) a:has(i.fa-edit)",
          "css=table#anexos\\:lista-anexos tr:has(td:nth-child(1):text-is('{{periodoTarget}}')) a.titulado[href*='editar-anexo.jsf']",
          "css=table#anexos\\:lista-anexos tr:has(td:nth-child(1):has-text('{{periodoTarget}}')) a.titulado[data-original-title*='Editar'][href*='editar-anexo.jsf']"
        ] },
        { "type": "waitForURL", "timeout": 60000, "pattern": "editar-anexo\\.jsf\\?anexo=" },
        { "type": "assertOnPage", "urlPattern": "editar-anexo\\.jsf\\?anexo=", "anyText": ["Anexo"] },
        { "type": "trySteps", "log": "wait link Mis facturas electrónicas", "steps": [
          { "type": "waitForSelector", "timeout": 60000, "selector": "css=a[href*='facturas-electronicas-agrupadas.jsf']" }
        ], "fallbackSteps": [
          { "type": "waitForSelector", "timeout": 60000, "selector": "css=a:has-text('Mis facturas electrónicas')" }
        ] },
        { "type": "clickAny", "logUrl": true, "selectors": ["css=a[href*='facturas-electronicas-agrupadas.jsf']","css=a:has-text('Mis facturas electrónicas')"] },
        { "type": "waitForURL", "timeout": 60000, "pattern": "facturas-electronicas-agrupadas\\.jsf|facturas-electronicas\\.jsf" }
      ]
    },
    {
      "type": "assertOnPage",
      "urlPattern": "facturas-electronicas",
      "anyText": ["Facturas", "electrónicas", "Mis facturas"]
    }
  ]
},

  "anexo_period_ensure": {
    "steps": [
      {
        "type": "assertOnPage",
        "urlPattern": "anexo-gastos-personales\\/anexos\\.jsf|\\/anexos\\.jsf",
        "anyText": ["Anexos"]
      },
      {
        "type": "trySteps",
        "log": "anexo_period_ensure periodoTarget={{periodoTarget}}",
        "steps": [
          {
            "type": "clickRowAction",
            "table": "css=table#anexos\\:lista-anexos",
            "rowText": "{{periodoTarget}}",
            "actionSelectors": [
              "css=td:nth-child(4) a.titulado[href*='editar-anexo.jsf']",
              "css=a.titulado[href*='editar-anexo.jsf']"
            ]
          }
        ],
        "fallbackSteps": [
          {
            "type": "clickAny",
            "selectors": [
              "css=a.btn.btn-sm.btn-primary:has-text('Nuevo')",
              "css=a[href*='nuevo-anexo.jsf']:has-text('Nuevo')"
            ]
          },
          {
            "type": "assertOnPage",
            "urlPattern": "nuevo-anexo\\.jsf",
            "anyText": ["Anexo"]
          },
          {
            "type": "assertOnPage",
            "selector": "css=select#reg_periodo"
          },
          {
            "type": "select",
            "selector": "css=select#reg_periodo",
            "label": "{{periodoTarget}}"
          },
          {
            "type": "assertOnPage",
            "selector": "css=input#reg_crear"
          },
          {
            "type": "click",
            "selector": "css=input#reg_crear"
          },
          {
            "type": "assertOnPage",
            "urlPattern": "anexo-gastos-personales\\/anexos\\.jsf|\\/anexos\\.jsf",
            "anyText": ["Anexos"]
          },
          {
            "type": "clickRowAction",
            "table": "css=table#anexos\\:lista-anexos",
            "rowText": "{{periodoTarget}}",
            "actionSelectors": [
              "css=td:nth-child(4) a.titulado[href*='editar-anexo.jsf']",
              "css=a.titulado[href*='editar-anexo.jsf']"
            ]
          }
        ]
      }
    ]
  },

  "anexo_open_anexos_home": {
    "steps": [
      {
        "type": "ensureSidebarOpen",
        "hamburger": "button#sri-menu",
        "sidebar1": "#mySidebar",
        "sidebar2": "#mySidebar2"
      },
      {
        "type": "clickAny",
        "selectors": [
          "css=#mySidebar a.ui-panelmenu-header-link:has-text('ANEXOS')",
          "css=#mySidebar span.ui-menuitem-text:has-text('ANEXOS')"
        ]
      },
      {
        "type": "clickAny",
        "selectors": [
          "css=#mySidebar a.ui-menuitem-link:has-text('Anexo de gastos personales en línea')",
          "css=#mySidebar span.ui-menuitem-text:has-text('Anexo de gastos personales en línea')"
        ]
      },
      {
        "type": "clickAny",
        "logUrlAfter": true,
        "selectors": [
          "css=#mySidebar a.ui-menuitem-link:has-text('Generación anexo')",
          "css=#mySidebar a.ui-menuitem-link[href*='tportal-internet/accederAplicacion.jspa?redireccion=101&idGrupo=98']",
          "css=#mySidebar a.ui-menuitem-link[href*='tportal-internet/accederAplicacion.jspa?redireccion=101']"
        ]
      },
      {
        "type": "waitForURL",
        "timeout": 60000,
        "pattern": "anexo-gastos-personales\\/anexos\\.jsf|\\/anexos\\.jsf"
      },
      {
        "type": "assertOnPage",
        "urlPattern": "anexo-gastos-personales\\/anexos\\.jsf|\\/anexos\\.jsf",
        "anyText": ["Anexos"]
      }
    ]
  },

  "anexo_open_editar_anexo_2025": {
    "steps": [
      {
        "type": "assertOnPage",
        "urlPattern": "anexo-gastos-personales\\/anexos\\.jsf|\\/anexos\\.jsf",
        "anyText": ["Anexos"]
      },
      {
        "type": "clickRowAction",
        "table": "css=table#anexos\\:lista-anexos",
        "rowText": "2025",
        "actionSelectors": [
          "css=a:has-text('Editar anexo')",
          "css=a:has-text('Editar')",
          "css=button:has-text('Editar anexo')",
          "css=button:has-text('Editar')"
        ]
      },
      {
        "type": "waitForURL",
        "pattern": "editar-anexo\\.jsf"
      },
      {
        "type": "assertOnPage",
        "urlPattern": "editar-anexo\\.jsf",
        "anyText": ["Anexo"]
      }
    ]
  },

  "anexo_open_facturas_electronicas": {
    "steps": [
      {
        "type": "assertOnPage",
        "urlPattern": "editar-anexo\\.jsf",
        "anyText": ["Anexo"]
      },
      {
        "type": "clickAny",
        "selectors": [
          "css=a[href*='facturas-electronicas-agrupadas.jsf']",
          "css=a:has-text('Mis facturas electrónicas')"
        ]
      },
      {
        "type": "waitForURL",
        "pattern": "facturas-electronicas-agrupadas\\.jsf"
      },
      {
        "type": "assertOnPage",
        "urlPattern": "facturas-electronicas-agrupadas\\.jsf",
        "anyText": ["Facturas electrónicas por proveedor", "Facturas electrónicas"]
      }
    ]
  },



  "proveedor_open_by_ruc": {
    "steps": [
      {
        "type": "assertOnPage",
        "urlPattern": "facturas-electronicas-agrupadas\\.jsf|facturas-electronicas\\.jsf\\?emisor=",
        "anyText": ["Facturas electrónicas"]
      },
      {
        "type": "trySteps",
        "log": "proveedor_open_by_ruc: abrir detalle por RUC {{ruc}}",
        "steps": [
          {
            "type": "clickRowAction",
            "table": "css=table#anchoDoc",
            "rowText": "{{ruc}}",
            "actionSelectors": [
              "css=a[href*='facturas-electronicas.jsf'][href*='emisor={{ruc}}']",
              "css=a[href*='facturas-electronicas.jsf'][href*='emisor=']",
              "css=a[onclick]",
              "css=a",
              "css=button"
            ]
          }
        ],
        "fallbackSteps": [
          {
            "type": "assertOnPage",
            "urlPattern": "facturas-electronicas\\.jsf\\?emisor=",
            "anyText": ["Facturas electrónicas"]
          }
        ]
      },
      {
        "type": "waitForURL",
        "timeout": 60000,
        "pattern": "facturas-electronicas\\.jsf\\?emisor="
      },
      {
        "type": "assertOnPage",
        "urlPattern": "facturas-electronicas\\.jsf\\?emisor=",
        "anyText": ["Facturas electrónicas"]
      }
    ]
  },

  "invoice_mark_category_by_numero": {
    "steps": [
      {
        "type": "assertOnPage",
        "urlPattern": "facturas-electronicas\\.jsf",
        "anyText": ["Facturas electrónicas"]
      },
      {
        "type": "trySteps",
        "log": "invoice_mark_category_by_numero: expandir todas las facturas",
        "steps": [
          {
            "type": "clickAny",
            "selectors": [
              "css=a:has-text('Expandir todo')",
              "css=button:has-text('Expandir todo')",
              "css=[role='button']:has-text('Expandir todo')",
              "css=a[title*='Expandir']",
              "css=button[title*='Expandir']"
            ]
          }
        ],
        "fallbackSteps": [
          {
            "type": "assertOnPage",
            "urlPattern": "facturas-electronicas\\.jsf",
            "anyText": ["Facturas electrónicas"]
          }
        ]
      },
      {
        "type": "waitForSelector",
        "timeout": 20000,
        "selector": "css=table#anchoDoc tr:has-text('FACTURA {{numero_factura}}'), table#anchoDoc tr:has-text('FACTURA {{numero_factura_compacto}}'), table#anchoDoc tr:has-text('{{numero_factura}}'), table#anchoDoc tr:has-text('{{numero_factura_compacto}}')"
      },
      {
        "type": "trySteps",
        "log": "invoice_mark_category_by_numero: esperar boton copiar categoria panel {{categoria_panel}} en factura {{numero_factura}}",
        "steps": [
          {
            "type": "waitForSelector",
            "timeout": 20000,
            "selector": "css=table#anchoDoc tr:has-text('FACTURA {{numero_factura}}') button.btn.btn-sm.btn-primary[onclick*='copiar('][onclick*='panel:{{categoria_panel}}:campo'], table#anchoDoc tr:has-text('FACTURA {{numero_factura_compacto}}') button.btn.btn-sm.btn-primary[onclick*='copiar('][onclick*='panel:{{categoria_panel}}:campo'], table#anchoDoc tr:has-text('{{numero_factura}}') button.btn.btn-sm.btn-primary[onclick*='copiar('][onclick*='panel:{{categoria_panel}}:campo'], table#anchoDoc tr:has-text('{{numero_factura_compacto}}') button.btn.btn-sm.btn-primary[onclick*='copiar('][onclick*='panel:{{categoria_panel}}:campo']"
          }
        ],
        "fallbackSteps": [
          {
            "type": "waitForSelector",
            "timeout": 20000,
            "selector": "css=table#anchoDoc tr:has-text('FACTURA {{numero_factura}}') div.form-group:has(label:has-text('{{categoria_label}}')) button.btn.btn-sm.btn-primary, table#anchoDoc tr:has-text('FACTURA {{numero_factura_compacto}}') div.form-group:has(label:has-text('{{categoria_label}}')) button.btn.btn-sm.btn-primary, table#anchoDoc tr:has-text('{{numero_factura}}') div.form-group:has(label:has-text('{{categoria_label}}')) button.btn.btn-sm.btn-primary, table#anchoDoc tr:has-text('{{numero_factura_compacto}}') div.form-group:has(label:has-text('{{categoria_label}}')) button.btn.btn-sm.btn-primary"
          }
        ]
      },
      {
        "type": "clickAny",
        "logUrl": true,
        "selectors": [
          "css=table#anchoDoc tr:has-text('FACTURA {{numero_factura}}') button.btn.btn-sm.btn-primary[onclick*='copiar('][onclick*='panel:{{categoria_panel}}:campo']",
          "css=table#anchoDoc tr:has-text('FACTURA {{numero_factura_compacto}}') button.btn.btn-sm.btn-primary[onclick*='copiar('][onclick*='panel:{{categoria_panel}}:campo']",
          "css=table#anchoDoc tr:has-text('{{numero_factura}}') button.btn.btn-sm.btn-primary[onclick*='copiar('][onclick*='panel:{{categoria_panel}}:campo']",
          "css=table#anchoDoc tr:has-text('{{numero_factura_compacto}}') button.btn.btn-sm.btn-primary[onclick*='copiar('][onclick*='panel:{{categoria_panel}}:campo']",
          "css=table#anchoDoc tr:has-text('FACTURA {{numero_factura}}') div.form-group:has(label:has-text('{{categoria_label}}')) button.btn.btn-sm.btn-primary",
          "css=table#anchoDoc tr:has-text('FACTURA {{numero_factura_compacto}}') div.form-group:has(label:has-text('{{categoria_label}}')) button.btn.btn-sm.btn-primary",
          "css=table#anchoDoc tr:has-text('{{numero_factura}}') div.form-group:has(label:has-text('{{categoria_label}}')) button.btn.btn-sm.btn-primary",
          "css=table#anchoDoc tr:has-text('{{numero_factura_compacto}}') div.form-group:has(label:has-text('{{categoria_label}}')) button.btn.btn-sm.btn-primary"
        ]
      }
    ]
  },

  "invoice_open": {
    "steps": [
      { "type": "fill", "selector": "REEMPLAZAR_SELECTOR_CLAVE", "text": "{{clave_acceso}}" },
      { "type": "click", "selector": "REEMPLAZAR_SELECTOR_ABRIR_FACTURA" }
    ]
  },
  "e2e_from_profile_assisted": {
    "steps": [
      {
        "type": "assertOnPage",
        "urlPattern": "contribuyente\/perfil"
      },
      {
        "type": "runAction",
        "actionName": "provider_open",
        "vars": { "periodoTarget": "{{periodoTarget}}" }
      },
      {
        "type": "trySteps",
        "log": "e2e: continuar si ya estamos en facturas agrupadas; fallback por flujo de anexos",
        "steps": [
          {
            "type": "assertOnPage",
            "urlPattern": "facturas-electronicas-agrupadas\\.jsf",
            "anyText": ["Facturas electrónicas por proveedor","Facturas electrónicas"]
          }
        ],
        "fallbackSteps": [
          {
            "type": "assertOnPage",
            "urlPattern": "anexo-gastos-personales\/anexos\\.jsf|\/anexos\\.jsf",
            "anyText": ["Anexos"]
          },
          {
            "type": "runAction",
            "actionName": "anexo_period_ensure",
            "vars": { "periodoTarget": "{{periodoTarget}}" }
          },
          {
            "type": "assertOnPage",
            "urlPattern": "editar-anexo\\.jsf",
            "anyText": ["Anexo"]
          },
          {
            "type": "runAction",
            "actionName": "anexo_open_facturas_electronicas"
          },
          {
            "type": "assertOnPage",
            "urlPattern": "facturas-electronicas-agrupadas\\.jsf",
            "anyText": ["Facturas electrónicas por proveedor","Facturas electrónicas"]
          }
        ]
      },
      {
        "type": "runAction",
        "actionName": "proveedor_open_by_ruc",
        "vars": { "ruc": "{{proveedor_ruc}}" }
      },
      {
        "type": "assertOnPage",
        "urlPattern": "facturas-electronicas\\.jsf\\?emisor=",
        "anyText": ["Facturas electrónicas"]
      },
      {
        "type": "runAction",
        "actionName": "invoice_mark_category_by_numero",
        "vars": {
          "numero_factura": "{{numero_factura}}",
          "categoria_panel": "{{categoria_panel}}",
          "categoria_label": "{{categoria_label}}"
        }
      },
      {
        "type": "assertOnPage",
        "urlPattern": "facturas-electronicas\\.jsf\\?emisor=|facturas-electronicas\\.jsf",
        "anyText": ["Facturas electrónicas"]
      },
      {
        "type": "clickAny",
        "logUrl": true,
        "selectors": [
          "css=input[type='submit'][value='Guardar']",
          "css=button:has-text('Guardar')",
          "css=input.btn.btn-primary.btn-sm[type='submit'][value*='Guardar']",
          "css=button.btn.btn-primary.btn-sm:has-text('Guardar')"
        ]
      },
      {
        "type": "trySteps",
        "log": "e2e: esperar finalizacion tras click en Guardar",
        "steps": [
          {
            "type": "waitForURL",
            "timeout": 20000,
            "pattern": "facturas-electronicas\\.jsf\\?emisor=|facturas-electronicas\\.jsf"
          }
        ],
        "fallbackSteps": [
          {
            "type": "assertOnPage",
            "urlPattern": "facturas-electronicas\\.jsf\\?emisor=|facturas-electronicas\\.jsf",
            "anyText": ["Facturas electrónicas"]
          }
        ]
      }
    ]
  },

  "apply": {
    "steps_before_confirm": [
      {
        "type": "assertOnPage",
        "urlPattern": "facturas-electronicas\\.jsf",
        "anyText": ["Facturas electrónicas"]
      },
      {
        "type": "waitForSelector",
        "selector": "css=select#categoria, select[id*='categoria'], select[name*='categoria']"
      },
      {
        "type": "clickAny",
        "logUrl": true,
        "selectors": [
          "css=section:has-text('Categor') button.btn-primary:has-text('Copiar')",
          "css=section:has-text('Categor') a.btn-primary:has-text('Copiar')",
          "css=button.btn-primary:has-text('Copiar')",
          "css=a.btn-primary:has-text('Copiar')",
          "css=button[aria-label*='subtotal']",
          "css=button:has-text('Subtotal')",
          "css=button:has-text('Copiar')",
          "css=a:has-text('Copiar')"
        ]
      }
    ],
    "category_selector": "css=select#categoria, select[id*='categoria'], select[name*='categoria']",
    "category_mode": "select",
    "category_map": {
      "123": { "value": "123" },
      "Categoria Ejemplo": { "label": "Categoria Ejemplo" }
    },
    "confirm_selector": "css=button:has-text('Guardar'), button:has-text('Aplicar'), input[type='submit'][value*='Guardar'], input[type='submit'][value*='Aplicar']",
    "confirm_success_selector": "css=.ui-growl-message, .ui-messages-info, .ui-messages-success, .toast, div:has-text('Guardado'), span:has-text('Guardado')",
    "confirm_timeout": 15000,
    "confirm_success_timeout": 15000
  }
}
